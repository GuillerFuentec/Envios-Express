import{A as U,a as $}from"./env-CiJp0Il3.js";/* empty css               *//* empty css                 */const C=({amount:e,currency:r,email:t,name:o})=>({amount:e,currency:r,email:t,metadata:{customer_name:o||""}}),I=async({amount:e,currency:r,email:t,name:o})=>{const n=await fetch(`${U}/api/payments/create-intent`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(C({amount:e,currency:r,email:t,name:o}))});if(!n.ok){const c=await n.text();throw new Error(`No pudimos iniciar el pago (${n.status}). ${c||""}`.trim())}const s=await n.json();if(!(s!=null&&s.clientSecret))throw new Error("Respuesta incompleta del servidor de pagos.");return s.clientSecret};var R="https://js.stripe.com/v3",_=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/;var k=function(){for(var r=document.querySelectorAll('script[src^="'.concat(R,'"]')),t=0;t<r.length;t++){var o=r[t];if(_.test(o.src))return o}return null},w=function(r){var t="",o=document.createElement("script");o.src="".concat(R).concat(t);var n=document.head||document.body;if(!n)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return n.appendChild(o),o},x=function(r,t){!r||!r._registerWrapper||r._registerWrapper({name:"stripe-js",version:"3.4.1",startTime:t})},l=null,p=null,f=null,A=function(r){return function(){r(new Error("Failed to load Stripe.js"))}},N=function(r,t){return function(){window.Stripe?r(window.Stripe):t(new Error("Stripe.js not available"))}},j=function(r){return l!==null?l:(l=new Promise(function(t,o){if(typeof window>"u"||typeof document>"u"){t(null);return}if(window.Stripe){t(window.Stripe);return}try{var n=k();if(!(n&&r)){if(!n)n=w(r);else if(n&&f!==null&&p!==null){var s;n.removeEventListener("load",f),n.removeEventListener("error",p),(s=n.parentNode)===null||s===void 0||s.removeChild(n),n=w(r)}}f=N(t,o),p=A(o),n.addEventListener("load",f),n.addEventListener("error",p)}catch(c){o(c);return}}),l.catch(function(t){return l=null,Promise.reject(t)}))},T=function(r,t,o){if(r===null)return null;var n=r.apply(void 0,t);return x(n,o),n},m,b=!1,q=function(){return m||(m=j(null).catch(function(r){return m=null,Promise.reject(r)}),m)};Promise.resolve().then(function(){return q()}).catch(function(e){b||console.warn(e)});var M=function(){for(var r=arguments.length,t=new Array(r),o=0;o<r;o++)t[o]=arguments[o];b=!0;var n=Date.now();return q().then(function(s){return T(s,t,n)})};let y;const L=()=>{if(!y){const e=$();if(!e)throw new Error("Falta la clave publica de Stripe (VITE_STRIPE_PUBLISHABLE_KEY).");y=M(e,{apiVersion:"2024-06-20"})}return y},i={form:document.getElementById("checkoutForm"),email:document.getElementById("checkoutEmail"),name:document.getElementById("checkoutName"),amount:document.getElementById("checkoutAmount"),status:document.getElementById("checkoutStatus"),submit:document.getElementById("checkoutSubmit"),paymentElement:document.getElementById("payment-element"),paymentRequest:document.getElementById("payment-request-button")},g=(()=>{const{dataset:e}=document.body||{};return{successUrl:(e==null?void 0:e.successUrl)||"/src/pages/checkout-success.html",failedUrl:(e==null?void 0:e.failedUrl)||"/src/pages/checkout-failed.html"}})(),a={elements:null,paymentElement:null,paymentRequestButton:null,paymentRequest:null,clientSecret:null,amount:9.99,currency:"usd"},F=e=>{try{return new Intl.NumberFormat("es-US",{style:"currency",currency:a.currency.toUpperCase()}).format(e)}catch{return`$${e} ${a.currency.toUpperCase()}`}},v=e=>!e||typeof window>"u"||e.startsWith("http")?e:e.startsWith("/")?`${window.location.origin}${e}`:`${window.location.origin}/${e}`,u=(e,r="info")=>{if(!i.status)return;const t=e?" · Modo demostracion":"";i.status.textContent=(e||"")+t,i.status.classList.remove("is-error","is-success"),r==="error"?i.status.classList.add("is-error"):r==="success"&&i.status.classList.add("is-success")},S=e=>{i.submit&&(i.submit.disabled=e,i.submit.textContent=e?"Procesando...":"Pagar ahora")},E=()=>{if(!i.amount)return a.amount;const e=parseFloat(i.amount.value);return!Number.isFinite(e)||e<=0||(a.amount=e),a.amount},W=e=>Math.round(e*100),B=()=>{a.paymentRequestButton&&(a.paymentRequestButton.destroy(),a.paymentRequestButton=null),a.paymentRequest=null,i.paymentRequest&&(i.paymentRequest.hidden=!0,i.paymentRequest.innerHTML="")},G=async(e,r)=>{if(!i.paymentRequest||!a.elements)return;B();const t=e.paymentRequest({country:"US",currency:a.currency,total:{label:"Paqueteria Caribeña Express",amount:W(a.amount)},requestPayerName:!0,requestPayerEmail:!0});if(!await t.canMakePayment())return;const n=a.elements.create("paymentRequestButton",{paymentRequest:t,style:{paymentRequestButton:{theme:"dark",height:"44px",type:"buy"}}});t.on("cancel",()=>{u("Pago cancelado por el usuario.","error")}),t.on("paymentmethod",async s=>{try{const{error:c}=await e.confirmPayment({clientSecret:r,payment_method:s.paymentMethod.id},{handleActions:!1});if(c){s.complete("fail"),u(c.message||"No pudimos procesar el pago.","error");return}s.complete("success");const{error:h,paymentIntent:d}=await e.confirmPayment({clientSecret:r});if(h){u(h.message||"Pago pendiente de accion adicional.","error");return}(d==null?void 0:d.status)==="succeeded"&&(u("Pago completado. Redirigiendo...","success"),window.setTimeout(()=>{window.location.assign(`${v(g.successUrl)}?payment_intent=${d.id}`)},500))}catch(c){s.complete("fail"),console.error("[checkout] Error con Payment Request",c),u("No pudimos completar el pago con Apple/Google Pay.","error")}}),n.mount(i.paymentRequest),i.paymentRequest.hidden=!1,a.paymentRequest=t,a.paymentRequestButton=n},P=async()=>{var e,r;if(i.paymentElement){u("Preparando pago seguro..."),B();try{const t=await I({amount:E(),currency:a.currency,email:(e=i.email)==null?void 0:e.value.trim(),name:(r=i.name)==null?void 0:r.value.trim()}),o=await L();a.clientSecret=t,a.paymentElement&&a.paymentElement.destroy(),a.elements=o.elements({clientSecret:t,appearance:{theme:"flat",variables:{colorPrimary:"#0f766e",colorText:"#1f2933",borderRadius:"12px"}}}),a.paymentElement=a.elements.create("payment"),a.paymentElement.mount(i.paymentElement),await G(o,t),u("Metodo de pago listo. Completa los datos y confirma tu pago.")}catch(t){console.error("[checkout] No se pudo montar el Payment Element",t),u("No pudimos inicial el pago. Revisa tu conexion o intenta mas tarde.","error")}}},O=async e=>{var r,t;if(e.preventDefault(),!a.elements){u("El metodo de pago no esta listo todavia.","error");return}S(!0),u("Confirmando pago...");try{const o=await L(),{error:n,paymentIntent:s}=await o.confirmPayment({elements:a.elements,redirect:"if_required",confirmParams:{return_url:v(g.successUrl),payment_method_data:{billing_details:{email:((r=i.email)==null?void 0:r.value.trim())||void 0,name:((t=i.name)==null?void 0:t.value.trim())||void 0}}}});if(n){console.error("[checkout] Error confirmando pago",n),u(n.message||"No pudimos procesar el pago.","error");return}if((s==null?void 0:s.status)==="succeeded"){u("Pago completado. Redirigiendo...","success"),setTimeout(()=>{window.location.assign(`${v(g.successUrl)}?payment_intent=${s.id}`)},900);return}u("Pago pendiente de confirmacion. Revisa tu bandeja o sigue las instrucciones adicionales.")}catch(o){console.error("[checkout] Fallo inesperado",o),u("No pudimos confirmar el pago. Intenta nuevamente.","error")}finally{S(!1)}},V=()=>{var e;i.form&&(E(),P(),(e=i.amount)==null||e.addEventListener("change",()=>{E(),u(`Actualizamos el monto a ${F(a.amount)}. Preparando pago...`),P()}),i.form.addEventListener("submit",O))};document.addEventListener("DOMContentLoaded",V);
